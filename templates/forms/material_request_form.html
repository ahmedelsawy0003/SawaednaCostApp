{% extends "layouts/base.html" %}

{% block title %}{% if material_request %}تعديل{% else %}إنشاء{% endif %} طلب مواد - سواعدنا{% endblock %}
{% block page_title %}{% if material_request %}تعديل{% else %}إنشاء{% endif %} طلب توريد مواد{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-import me-2"></i>
                        {% if material_request %}تعديل طلب توريد مواد - {{ material_request.request_number }}{% else %}طلب توريد مواد جديد{% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="materialRequestForm">
                        <!-- Basic Information -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label required">المشروع</label>
                                <select name="project_id" class="form-select" required>
                                    <option value="">اختر المشروع</option>
                                    {% for project in projects %}
                                    <option value="{{ project.id }}" {% if material_request and material_request.project_id == project.id %}selected{% endif %}>
                                        {{ project.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">البند (اختياري)</label>
                                <select name="boq_item_id" class="form-select">
                                    <option value="">بدون ربط ببند</option>
                                    {% for item in boq_items %}
                                    <option value="{{ item.id }}" {% if material_request and material_request.boq_item_id == item.id %}selected{% endif %}>
                                        {{ item.item_number }} - {{ item.description[:50] }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label required">تاريخ الطلب</label>
                                <input type="date" name="request_date" class="form-control" 
                                       value="{% if material_request %}{{ material_request.request_date }}{% else %}{{ today }}{% endif %}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">مدير المشروع</label>
                                <select name="project_manager_id" class="form-select">
                                    <option value="">اختر مدير المشروع</option>
                                    {% for user in users %}
                                    <option value="{{ user.id }}" {% if material_request and material_request.project_manager_id == user.id %}selected{% endif %}>
                                        {{ user.username }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Items Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">بنود المواد</h6>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="addItem()">
                                        <i class="fas fa-plus me-1"></i>
                                        إضافة بند
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="itemsContainer">
                                    {% if material_request and material_request.items %}
                                        {% for item in material_request.items %}
                                        <div class="item-row border rounded p-3 mb-3" data-index="{{ loop.index0 }}">
                                            <div class="d-flex justify-content-between mb-2">
                                                <h6 class="text-primary">بند رقم <span class="item-number">{{ loop.index }}</span></h6>
                                                <button type="button" class="btn btn-sm btn-danger" onclick="removeItem(this)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                            <div class="row g-3">
                                                <div class="col-md-3">
                                                    <label class="form-label">رقم البند</label>
                                                    <input type="text" name="item_{{ loop.index0 }}_boq_number" class="form-control" 
                                                           value="{{ item.boq_item_number }}" placeholder="اختياري">
                                                </div>
                                                <div class="col-md-9">
                                                    <label class="form-label required">اسم المادة</label>
                                                    <input type="text" name="item_{{ loop.index0 }}_name" class="form-control" 
                                                           value="{{ item.material_name }}" required>
                                                </div>
                                                <div class="col-md-12">
                                                    <label class="form-label">الوصف</label>
                                                    <textarea name="item_{{ loop.index0 }}_description" class="form-control" rows="2">{{ item.description }}</textarea>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label required">الوحدة</label>
                                                    <input type="text" name="item_{{ loop.index0 }}_unit" class="form-control" 
                                                           value="{{ item.unit }}" placeholder="متر، طن، إلخ" required>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">الكمية المتاحة</label>
                                                    <input type="number" step="0.01" name="item_{{ loop.index0 }}_available" 
                                                           class="form-control" value="{{ item.quantity_available }}">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label required">الكمية المطلوبة</label>
                                                    <input type="number" step="0.01" name="item_{{ loop.index0 }}_requested" 
                                                           class="form-control" value="{{ item.quantity_requested }}" required>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label required">تاريخ التوريد المطلوب</label>
                                                    <input type="date" name="item_{{ loop.index0 }}_required_date" 
                                                           class="form-control" value="{{ item.required_date }}" required>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <!-- Empty template for first item -->
                                        <div class="item-row border rounded p-3 mb-3" data-index="0">
                                            <div class="d-flex justify-content-between mb-2">
                                                <h6 class="text-primary">بند رقم <span class="item-number">1</span></h6>
                                                <button type="button" class="btn btn-sm btn-danger" onclick="removeItem(this)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                            <div class="row g-3">
                                                <div class="col-md-3">
                                                    <label class="form-label">رقم البند</label>
                                                    <input type="text" name="item_0_boq_number" class="form-control" placeholder="اختياري">
                                                </div>
                                                <div class="col-md-9">
                                                    <label class="form-label required">اسم المادة</label>
                                                    <input type="text" name="item_0_name" class="form-control" required>
                                                </div>
                                                <div class="col-md-12">
                                                    <label class="form-label">الوصف</label>
                                                    <textarea name="item_0_description" class="form-control" rows="2"></textarea>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label required">الوحدة</label>
                                                    <input type="text" name="item_0_unit" class="form-control" placeholder="متر، طن، إلخ" required>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">الكمية المتاحة</label>
                                                    <input type="number" step="0.01" name="item_0_available" class="form-control">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label required">الكمية المطلوبة</label>
                                                    <input type="number" step="0.01" name="item_0_requested" class="form-control" required>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label required">تاريخ التوريد المطلوب</label>
                                                    <input type="date" name="item_0_required_date" class="form-control" required>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                                <input type="hidden" name="item_count" id="itemCount" value="{% if material_request and material_request.items %}{{ material_request.items|length }}{% else %}1{% endif %}">
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="mb-4">
                            <label class="form-label">ملاحظات</label>
                            <textarea name="notes" class="form-control" rows="3">{% if material_request %}{{ material_request.notes }}{% endif %}</textarea>
                        </div>

                        <!-- Actions -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('forms.material_requests') }}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>
                                إلغاء
                            </a>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>
                                    {% if material_request %}تحديث{% else %}حفظ{% endif %}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let itemIndex = parseInt(document.getElementById('itemCount').value);

function addItem() {
    const container = document.getElementById('itemsContainer');
    const newItem = document.createElement('div');
    newItem.className = 'item-row border rounded p-3 mb-3';
    newItem.setAttribute('data-index', itemIndex);
    
    newItem.innerHTML = `
        <div class="d-flex justify-content-between mb-2">
            <h6 class="text-primary">بند رقم <span class="item-number">${itemIndex + 1}</span></h6>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeItem(this)">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">رقم البند</label>
                <input type="text" name="item_${itemIndex}_boq_number" class="form-control" placeholder="اختياري">
            </div>
            <div class="col-md-9">
                <label class="form-label required">اسم المادة</label>
                <input type="text" name="item_${itemIndex}_name" class="form-control" required>
            </div>
            <div class="col-md-12">
                <label class="form-label">الوصف</label>
                <textarea name="item_${itemIndex}_description" class="form-control" rows="2"></textarea>
            </div>
            <div class="col-md-3">
                <label class="form-label required">الوحدة</label>
                <input type="text" name="item_${itemIndex}_unit" class="form-control" placeholder="متر، طن، إلخ" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">الكمية المتاحة</label>
                <input type="number" step="0.01" name="item_${itemIndex}_available" class="form-control">
            </div>
            <div class="col-md-3">
                <label class="form-label required">الكمية المطلوبة</label>
                <input type="number" step="0.01" name="item_${itemIndex}_requested" class="form-control" required>
            </div>
            <div class="col-md-3">
                <label class="form-label required">تاريخ التوريد المطلوب</label>
                <input type="date" name="item_${itemIndex}_required_date" class="form-control" required>
            </div>
        </div>
    `;
    
    container.appendChild(newItem);
    itemIndex++;
    document.getElementById('itemCount').value = itemIndex;
    updateItemNumbers();
}

function removeItem(button) {
    const itemRow = button.closest('.item-row');
    const container = document.getElementById('itemsContainer');
    
    if (container.children.length > 1) {
        itemRow.remove();
        updateItemNumbers();
    } else {
        alert('يجب أن يحتوي الطلب على بند واحد على الأقل');
    }
}

function updateItemNumbers() {
    const items = document.querySelectorAll('.item-row');
    items.forEach((item, index) => {
        item.querySelector('.item-number').textContent = index + 1;
    });
}
</script>

<style>
.required::after {
    content: " *";
    color: red;
}

.item-row {
    background-color: #f8f9fa;
    transition: all 0.3s;
}

.item-row:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
</style>
{% endblock %}

