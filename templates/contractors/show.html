{% extends "layouts/base.html" %}

{% block title %}تفاصيل المقاول - {{ contractor.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <h2 class="mb-0">
        <i class="fas fa-hard-hat fa-fw me-2 text-primary"></i>
        <span class="text-muted fw-normal">ملف المقاول:</span> {{ contractor.name }}
    </h2>
    <div class="d-flex gap-2">
        {% if current_user.role in ['admin', 'sub-admin'] %}
        <a href="{{ url_for('contractor.edit_contractor', contractor_id=contractor.id) }}" class="btn btn-warning" data-bs-toggle="tooltip" title="تعديل بيانات المقاول الأساسية">
            <i class="fas fa-edit me-1"></i> تعديل البيانات
        </a>
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteContractorModal-{{ contractor.id }}" title="حذف المقاول نهائياً">
            <i class="fas fa-trash me-1"></i> حذف المقاول
        </button>
        {% endif %}
        <a href="{{ url_for('contractor.get_contractors') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-right me-1"></i> العودة للقائمة
        </a>
    </div>
</div>

{# --- Financial Summary Cards --- #}
<div class="card mb-4">
    <div class="card-header bg-dark text-white">
        <h4 class="mb-0"><i class="fas fa-chart-line fa-fw me-2"></i>الملخص المالي للمقاول (لجميع المشاريع)</h4>
    </div>
    <div class="card-body">
        <div class="row text-center g-3">
            {# Total Due #}
            <div class="col-md-4">
                <div class="p-3 border rounded h-100 border-primary border-3">
                    <h5 class="text-muted small">إجمالي المستحق (من المستخلصات)</h5>
                    <p class="fs-4 text-primary fw-bold number-cell">{{ "{:,.2f}".format(total_due) }} <span class="small text-muted">ر.س</span></p>
                </div>
            </div>
            {# Total Paid #}
            <div class="col-md-4">
                <div class="p-3 border rounded h-100 border-success border-3">
                    <h5 class="text-muted small">إجمالي المدفوع</h5>
                    <p class="fs-4 text-success fw-bold number-cell">{{ "{:,.2f}".format(total_paid) }} <span class="small text-muted">ر.س</span></p>
                </div>
            </div>
            {# Remaining #}
            <div class="col-md-4">
                <div class="p-3 border rounded h-100 border-danger border-3">
                    <h5 class="text-muted small">إجمالي المتبقي للدفع</h5>
                    <p class="fs-4 text-danger fw-bold number-cell">{{ "{:,.2f}".format(remaining) }} <span class="small text-muted">ر.س</span></p>
                </div>
            </div>
        </div>
        
        {% if contractor.notes %}
            <hr class="mt-4 mb-3">
            <p class="mb-0"><strong class="d-block mb-1 text-muted"><i class="fas fa-clipboard-list me-1"></i> ملاحظات المقاول:</strong> {{ contractor.notes }}</p>
        {% endif %}
    </div>
</div>

{# --- Tabs Structure for Invoices and Items --- #}
<div class="card">
    <div class="card-header p-0">
        <ul class="nav nav-tabs card-header-tabs" id="contractorTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="invoices-tab" data-bs-toggle="tab" data-bs-target="#invoices-content" type="button" role="tab" aria-controls="invoices-content" aria-selected="true">
                    <i class="fas fa-file-invoice-dollar me-1"></i>سجل المستخلصات ({{ invoices|length }})
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="items-tab" data-bs-toggle="tab" data-bs-target="#items-content" type="button" role="tab" aria-controls="items-content" aria-selected="false">
                    <i class="fas fa-tasks me-1"></i>البنود المسندة ({{ assigned_items|length }})
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body p-0">
        <div class="tab-content" id="contractorTabContent">
            
            <div class="tab-pane fade show active" id="invoices-content" role="tabpanel" aria-labelledby="invoices-tab">
                
                <div class="p-3">
                    <form method="GET" action="{{ url_for('contractor.show_contractor', contractor_id=contractor.id) }}" class="mb-3">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label">تصفية حسب المشروع</label>
                                <select name="project_id" class="form-select">
                                    <option value="">جميع المشاريع</option>
                                    {% for project in projects %}
                                        <option value="{{ project.id }}" {% if filters.project_id == project.id %}selected{% endif %}>{{ project.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">بحث برقم المستخلص</label>
                                <input type="search" name="search" class="form-control" value="{{ filters.search or '' }}" placeholder="ابحث برقم المستخلص">
                            </div>
                            <div class="col-md-4 d-flex gap-2">
                                <button type="submit" class="btn btn-primary w-100" title="تطبيق الفلتر"><i class="fas fa-search me-1"></i> بحث</button>
                                <a href="{{ url_for('contractor.show_contractor', contractor_id=contractor.id) }}" class="btn btn-secondary w-100" title="مسح الفلاتر"><i class="fas fa-times me-1"></i> مسح</a>
                            </div>
                        </div>
                    </form>
                    <div class="d-flex justify-content-end mb-2">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-info" id="expand-all-btn" title="توسيع الكل"><i class="fas fa-angle-double-down"></i></button>
                            <button class="btn btn-outline-info" id="collapse-all-btn" title="طي الكل"><i class="fas fa-angle-double-up"></i></button>
                        </div>
                    </div>
                </div>

                {% if invoices %}
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 3%;"></th>
                                    <th>رقم المستخلص</th>
                                    <th>المشروع</th>
                                    <th>تاريخه</th>
                                    <th class="text-end">الإجمالي (ر.س)</th>
                                    <th class="text-end">المدفوع (ر.س)</th>
                                    <th class="text-center">الحالة</th>
                                    <th class="text-center">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="invoices-tbody">
                                {% for invoice in invoices %}
                                <tr class="align-middle">
                                    <td>
                                        {% if invoice.items %}
                                        <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#invoice-items-{{ invoice.id }}" title="عرض بنود المستخلص">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                        {% endif %}
                                    </td>
                                    <td><a href="{{ url_for('invoice.show_invoice', invoice_id=invoice.id) }}" class="fw-bold">{{ invoice.invoice_number }}</a></td>
                                    <td>{{ invoice.project.name }}</td>
                                    <td>{{ invoice.invoice_date.strftime('%Y-%m-%d') }}</td>
                                    <td class="text-end number-cell fw-bold">{{ "{:,.2f}".format(invoice.total_amount) }}</td>
                                    <td class="text-end text-success number-cell">{{ "{:,.2f}".format(invoice.paid_amount) }}</td>
                                    <td class="text-center">
                                        <span class="badge 
                                            {% if invoice.status == 'مدفوع بالكامل' %} bg-success 
                                            {% elif invoice.status == 'مدفوع جزئياً' %} bg-warning text-dark 
                                            {% elif invoice.status == 'معتمد' %} bg-info 
                                            {% elif invoice.status == 'ملغي' %} bg-danger 
                                            {% else %} bg-secondary {% endif %}">
                                            {{ invoice.status }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <a href="{{ url_for('invoice.show_invoice', invoice_id=invoice.id) }}" class="btn btn-info btn-sm" title="عرض تفاصيل المستخلص"><i class="fas fa-eye"></i></a>
                                    </td>
                                </tr>
                                {% if invoice.items %}
                                <tr class="collapse bg-light" id="invoice-items-{{ invoice.id }}">
                                    <td colspan="8" class="p-3">
                                        <h6 class="text-primary mb-2"><i class="fas fa-sitemap me-1"></i>تفاصيل بنود المستخلص:</h6>
                                        <div class="table-responsive border p-2">
                                            <table class="table table-sm table-striped table-hover mb-0">
                                                <thead class="bg-light">
                                                    <tr>
                                                        <th>وصف البند</th>
                                                        <th class="text-end">الإجمالي (ر.س)</th>
                                                        <th class="text-end">المدفوع (ر.س)</th>
                                                        <th class="text-end">المتبقي (ر.س)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for inv_item in invoice.items %}
                                                    <tr>
                                                        <td class="text-muted">{{ inv_item.description }}</td>
                                                        <td class="text-end number-cell fw-bold">{{ "{:,.2f}".format(inv_item.total_price) }}</td>
                                                        <td class="text-end text-success number-cell">{{ "{:,.2f}".format(inv_item.paid_amount) }}</td>
                                                        <td class="text-end text-danger number-cell">{{ "{:,.2f}".format(inv_item.remaining_amount) }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info m-3 text-center p-4">
                         <h4 class="alert-heading"><i class="fas fa-file-invoice-slash me-2"></i> لا توجد مستخلصات مسجلة!</h4>
                         <p class="mb-0">
                            لا توجد مستخلصات مسجلة لهذا المقاول حالياً، أو أنها لا تتطابق مع فلتر المشروع المحدد.
                            <br>
                            يمكنك البدء بـ **<a href="{{ url_for('contractor.show_contractor', contractor_id=contractor.id) }}" class="alert-link">مسح الفلتر</a>** أو الانتقال لأحد المشاريع لإنشاء مستخلص جديد.
                        </p>
                    </div>
                {% endif %}
            </div>

            <div class="tab-pane fade" id="items-content" role="tabpanel" aria-labelledby="items-tab">
                <div class="p-3">
                    <h6 class="mb-3 text-muted"><i class="fas fa-info-circle me-1"></i> البنود التي تم إسنادها للمقاول في المشاريع (تشمل بنود العقد وتفاصيل التكلفة)</h6>
                </div>
                {% if assigned_items %}
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 15%;">رقم البند</th>
                                    <th style="width: 40%;">الوصف</th>
                                    <th style="width: 20%;">المشروع</th>
                                    <th class="text-end" style="width: 15%;">التكلفة الفعلية (ر.س)</th>
                                    <th class="text-center" style="width: 5%;">الحالة</th>
                                    <th class="text-center" style="width: 5%;">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in assigned_items %}
                                <tr>
                                    <td>{{ item.item_number }}</td>
                                    <td>{{ item.short_description }}</td>
                                    <td><a href="{{ url_for('project.get_project', project_id=item.project_id) }}">{{ item.project.name }}</a></td>
                                    <td class="text-end number-cell text-primary">{{ "{:,.2f}".format(item.actual_total_cost) }}</td>
                                    <td class="text-center">
                                        <span class="badge 
                                            {% if item.status == "نشط" %} bg-warning 
                                            {% elif item.status == "مكتمل" %} bg-success 
                                            {% else %} bg-info 
                                            {% endif %}">
                                            {{ item.status }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <a href="{{ url_for('item.edit_item', item_id=item.id) }}" class="btn btn-warning btn-sm" title="تعديل البند"><i class="fas fa-edit"></i></a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info m-3 text-center p-4">
                        <h4 class="alert-heading"><i class="fas fa-tasks-alt me-2"></i> لا توجد بنود عمل مسندة!</h4>
                        <p class="mb-0">
                            لم يتم إسناد أي بنود عمل (أو تفاصيل تكلفة) لهذا المقاول بشكل مباشر في أي مشروع حتى الآن.
                            <br>
                            يرجى التأكد من اختيار هذا المقاول عند إضافة بند عمل أو تفصيل تكلفة جديد.
                        </p>
                    </div>
                {% endif %}
            </div>

        </div>
    </div>
</div>

{# --- Delete Confirmation Modal --- #}
<div class="modal fade" id="deleteContractorModal-{{ contractor.id }}" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">تأكيد الحذف</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>هل أنت متأكد أنك تريد حذف المقاول <strong>{{ contractor.name }}</strong>؟</p>
                <p class="text-danger small">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    لا يمكن حذف المقاول إذا كان مرتبطًا بأي مستخلصات أو بنود عمل.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <form action="{{ url_for('contractor.delete_contractor', contractor_id=contractor.id) }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-danger">تأكيد الحذف</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{# --- START: الكود النهائي المحسن للسرعة (مكرر من ملف المقاولين) --- #}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const expandAllBtn = document.getElementById('expand-all-btn');
    const collapseAllBtn = document.getElementById('collapse-all-btn');
    const collapsibleItems = document.querySelectorAll('#invoices-tbody .collapse');

    // دالة لإيقاف الحركة مؤقتاً
    function bulkToggle(action) {
        collapsibleItems.forEach(item => {
            // نضيف كلاس يوقف الحركة
            item.classList.add('no-transition');
            // نستخدم getInstance للحصول على نسخة موجودة أو getOrCreateInstance
            const bsCollapse = bootstrap.Collapse.getOrCreateInstance(item); 
            if (action === 'show') {
                bsCollapse.show();
            } else {
                bsCollapse.hide();
            }
            // نزيل الكلاس بعد انتهاء العملية مباشرة
            setTimeout(() => {
                item.classList.remove('no-transition');
            }, 0);
        });
    }

    if (expandAllBtn && collapseAllBtn && collapsibleItems.length > 0) {
        expandAllBtn.addEventListener('click', () => bulkToggle('show'));
        collapseAllBtn.addEventListener('click', () => bulkToggle('hide'));
    }
});
</script>
{# --- END: الكود النهائي --- #}
{% endblock %}