{% extends "layouts/base.html" %}

{% block title %}تفاصيل المقاول - {{ contractor.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
        <i class="fas fa-hard-hat fa-fw me-2 text-muted"></i>
        <span class="text-muted fw-normal">ملف المقاول:</span> {{ contractor.name }}
    </h2>
    <div class="d-flex gap-2">
        {% if current_user.role in ['admin', 'sub-admin'] %}
        <a href="{{ url_for('contractor.edit_contractor', contractor_id=contractor.id) }}" class="btn btn-warning" data-bs-toggle="tooltip" title="تعديل بيانات المقاول">
            <i class="fas fa-edit me-1"></i> تعديل البيانات
        </a>
        {% endif %}
        <a href="{{ url_for('contractor.get_contractors') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-right me-1"></i> العودة للقائمة
        </a>
    </div>
</div>

{# --- Financial Summary Cards --- #}
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0"><i class="fas fa-chart-line fa-fw me-2"></i>الملخص المالي للمقاول</h4>
    </div>
    <div class="card-body">
        <div class="row text-center g-3">
            <div class="col-md-4">
                <div class="p-3 border rounded h-100 bg-light">
                    <h5 class="text-muted small">إجمالي المستحق (من المستخلصات المعتمدة)</h5>
                    <p class="fs-4 text-primary fw-bold number-cell">{{ "{:,.2f}".format(total_due) }} <span class="small text-muted">ر.س</span></p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 border rounded h-100 border-success">
                    <h5 class="text-muted small">إجمالي المدفوع</h5>
                    <p class="fs-4 text-success fw-bold number-cell">{{ "{:,.2f}".format(total_paid) }} <span class="small text-muted">ر.س</span></p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 border rounded h-100 border-danger">
                    <h5 class="text-muted small">إجمالي المتبقي للدفع</h5>
                    <p class="fs-4 text-danger fw-bold number-cell">{{ "{:,.2f}".format(remaining) }} <span class="small text-muted">ر.س</span></p>
                </div>
            </div>
        </div>
        
        {% if contractor.notes %}
            <hr class="mt-4 mb-3">
            <p class="mb-0"><strong class="d-block mb-1 text-muted">ملاحظات المقاول:</strong> {{ contractor.notes }}</p>
        {% endif %}
    </div>
</div>

{# --- Tabs Structure for Invoices and Items --- #}
<div class="card">
    <div class="card-header p-0">
        <ul class="nav nav-tabs card-header-tabs" id="contractorTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="invoices-tab" data-bs-toggle="tab" data-bs-target="#invoices-content" type="button" role="tab" aria-controls="invoices-content" aria-selected="true">
                    <i class="fas fa-file-invoice-dollar me-1"></i>المستخلصات ({{ invoices|length }})
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="items-tab" data-bs-toggle="tab" data-bs-target="#items-content" type="button" role="tab" aria-controls="items-content" aria-selected="false">
                    <i class="fas fa-tasks me-1"></i>البنود المسندة ({{ assigned_items|length }})
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body p-0">
        <div class="tab-content" id="contractorTabContent">
            
            <div class="tab-pane fade show active" id="invoices-content" role="tabpanel" aria-labelledby="invoices-tab">
                
                <div class="p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0 text-muted">المستخلصات المرتبطة بالمقاول ({{ contractor.name }})</h6>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" id="expand-all-btn" title="توسيع الكل"><i class="fas fa-angle-double-down"></i></button>
                            <button class="btn btn-outline-secondary" id="collapse-all-btn" title="طي الكل"><i class="fas fa-angle-double-up"></i></button>
                        </div>
                    </div>
                </div>

                {% if invoices %}
                    <div class="table-responsive">
                        <table class="table table-dark table-hover table-striped mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 3%;"></th>
                                    <th>رقم المستخلص</th>
                                    <th>المشروع</th>
                                    <th>تاريخه</th>
                                    <th class="text-end">الإجمالي</th>
                                    <th class="text-end">المدفوع</th>
                                    <th class="text-center">الحالة</th>
                                    <th class="text-center">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="invoices-tbody">
                                {% for invoice in invoices %}
                                <tr class="align-middle">
                                    <td>
                                        {% if invoice.items %}
                                        <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#invoice-items-{{ invoice.id }}" title="عرض بنود المستخلص">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                        {% endif %}
                                    </td>
                                    <td><a href="{{ url_for('invoice.show_invoice', invoice_id=invoice.id) }}" class="fw-bold">{{ invoice.invoice_number }}</a></td>
                                    <td>{{ invoice.project.name }}</td>
                                    <td>{{ invoice.invoice_date.strftime('%Y-%m-%d') }}</td>
                                    <td class="text-end number-cell fw-bold">{{ "{:,.2f}".format(invoice.total_amount) }}</td>
                                    <td class="text-end text-success number-cell">{{ "{:,.2f}".format(invoice.paid_amount) }}</td>
                                    <td class="text-center">
                                        <span class="badge 
                                            {% if invoice.status == 'مدفوع بالكامل' %} bg-success 
                                            {% elif invoice.status == 'مدفوع جزئياً' %} bg-warning text-dark 
                                            {% elif invoice.status == 'معتمد' %} bg-info 
                                            {% elif invoice.status == 'ملغي' %} bg-danger 
                                            {% else %} bg-secondary {% endif %}">
                                            {{ invoice.status }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <a href="{{ url_for('invoice.show_invoice', invoice_id=invoice.id) }}" class="btn btn-info btn-sm" title="عرض تفاصيل المستخلص"><i class="fas fa-eye"></i></a>
                                    </td>
                                </tr>
                                {% if invoice.items %}
                                <tr class="collapse bg-card" id="invoice-items-{{ invoice.id }}">
                                    <td colspan="8" class="p-3">
                                        <h6 class="text-primary mb-2"><i class="fas fa-sitemap me-1"></i>تفاصيل بنود المستخلص:</h6>
                                        <div class="table-responsive border p-2">
                                            <table class="table table-sm table-striped table-hover mb-0">
                                                <thead class="bg-light">
                                                    <tr>
                                                        <th>البند</th>
                                                        <th class="text-end">الإجمالي</th>
                                                        <th class="text-end">المدفوع</th>
                                                        <th class="text-end">المتبقي</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for inv_item in invoice.items %}
                                                    <tr>
                                                        <td class="text-muted">{{ inv_item.description }}</td>
                                                        <td class="text-end number-cell fw-bold">{{ "{:,.2f}".format(inv_item.total_price) }}</td>
                                                        <td class="text-end text-success number-cell">{{ "{:,.2f}".format(inv_item.paid_amount) }}</td>
                                                        <td class="text-end text-danger number-cell">{{ "{:,.2f}".format(inv_item.remaining_amount) }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-secondary m-3 text-center">لا توجد مستخلصات مسجلة لهذا المقاول.</div>
                {% endif %}
            </div>

            <div class="tab-pane fade" id="items-content" role="tabpanel" aria-labelledby="items-tab">
                <div class="p-3">
                    <h6 class="mb-3 text-muted">البنود التي تم إسنادها للمقاول في المشاريع (تشمل بنود العقد وتفاصيل التكلفة)</h6>
                </div>
                {% if assigned_items %}
                    <div class="table-responsive">
                        <table class="table table-dark table-hover table-striped mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>رقم البند</th>
                                    <th>الوصف</th>
                                    <th>المشروع</th>
                                    <th class="text-end">التكلفة الفعلية</th>
                                    <th class="text-center">الحالة</th>
                                    <th class="text-center">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in assigned_items %}
                                <tr>
                                    <td>{{ item.item_number }}</td>
                                    <td>{{ item.short_description }}</td>
                                    <td><a href="{{ url_for('project.get_project', project_id=item.project_id) }}">{{ item.project.name }}</a></td>
                                    <td class="text-end number-cell">{{ "{:,.2f}".format(item.actual_total_cost) }}</td>
                                    <td class="text-center">
                                        <span class="badge 
                                            {% if item.status == "نشط" %} bg-warning 
                                            {% elif item.status == "مكتمل" %} bg-success 
                                            {% else %} bg-info 
                                            {% endif %}">
                                            {{ item.status }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <a href="{{ url_for('item.edit_item', item_id=item.id) }}" class="btn btn-warning btn-sm" title="تعديل البند"><i class="fas fa-edit"></i></a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-secondary m-3 text-center">لم يتم إسناد أي بنود لهذا المقاول بشكل مباشر.</div>
                {% endif %}
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{# --- START: الكود النهائي المحسن للسرعة --- #}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const expandAllBtn = document.getElementById('expand-all-btn');
    const collapseAllBtn = document.getElementById('collapse-all-btn');
    const collapsibleItems = document.querySelectorAll('#invoices-tbody .collapse');

    // دالة لإيقاف الحركة مؤقتاً
    function bulkToggle(action) {
        collapsibleItems.forEach(item => {
            // نضيف كلاس يوقف الحركة
            item.classList.add('no-transition');
            const bsCollapse = bootstrap.Collapse.getOrCreateInstance(item);
            if (action === 'show') {
                bsCollapse.show();
            } else {
                bsCollapse.hide();
            }
            // نزيل الكلاس بعد انتهاء العملية مباشرة
            // نستخدم setTimeout بصفر لإعطاء المتصفح فرصة لتنفيذ الأمر ثم إزالة الكلاس
            setTimeout(() => {
                item.classList.remove('no-transition');
            }, 0);
        });
    }

    if (expandAllBtn && collapseAllBtn && collapsibleItems.length > 0) {
        expandAllBtn.addEventListener('click', () => bulkToggle('show'));
        collapseAllBtn.addEventListener('click', () => bulkToggle('hide'));
    }
});
</script>
{# --- END: الكود النهائي --- #}
{% endblock %}