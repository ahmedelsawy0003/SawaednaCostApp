{% extends "layouts/base.html" %}

{% block title %}تعديل الدفعة - {{ payment.id }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <h2 class="mb-0">
        <i class="fas fa-edit fa-fw me-2 text-primary"></i>
        <span class="text-muted fw-normal">تعديل الدفعة رقم {{ payment.id }} للمستخلص:</span> 
        <a href="{{ url_for('invoice.show_invoice', invoice_id=payment.invoice_id) }}">{{ payment.invoice.invoice_number }}</a>
    </h2>
    <a href="{{ url_for('invoice.show_invoice', invoice_id=payment.invoice_id) }}" class="btn btn-secondary">
        <i class="fas fa-arrow-right me-1"></i> العودة للمستخلص
    </a>
</div>

<div class="card">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0"><i class="fas fa-money-check-alt me-2"></i>بيانات الدفعة وتوزيعها</h4>
    </div>
    <div class="card-body">
        <form id="paymentForm" method="POST" action="{{ url_for('invoice.edit_payment', payment_id=payment.id) }}">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-1"></i>
                يمكنك تعديل المبلغ المدفوع لكل بند. **الحد الأقصى** المسموح به لكل بند هو: (المبلغ المتبقي الحالي في المستخلص) + (المبلغ الذي كان مدفوعًا لهذا البند في هذه الدفعة سابقاً).
            </div>
            <div class="row mb-3 g-3">
                <div class="col-md-6">
                    <label for="payment_date" class="form-label">تاريخ الدفعة</label>
                    <input type="date" class="form-control" id="payment_date" name="payment_date" value="{{ payment.payment_date.strftime('%Y-%m-%d') }}" required>
                </div>
                <div class="col-md-6">
                    <label for="description" class="form-label">الوصف (اختياري)</label>
                    <input type="text" class="form-control" id="description" name="description" value="{{ payment.description or '' }}" placeholder="وصف الدفعة أو مرجعها">
                </div>
            </div>
            
            <h5 class="mt-4 text-primary"><i class="fas fa-sliders-h me-1"></i> توزيع مبلغ الدفعة على بنود المستخلص</h5>
            <div class="table-responsive">
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>البند</th>
                            <th class="text-end" style="width: 200px;" data-bs-toggle="tooltip" title="الحد الأقصى المسموح لك بدفعه لهذا البند في هذه العملية (المتبقي + المبلغ الحالي في هذه الدفعة)">الحد الأقصى للدفع (ر.س)</th>
                            <th style="width: 150px;">المبلغ المدفوع (ر.س)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for inv_item in invoice.items %}
                            {% set current_dist_amount = dists.get(inv_item.id, 0) %}
                            {# Maximum allowed = Remaining amount + Current amount for this item in THIS payment #}
                            {% set max_allowed = inv_item.remaining_amount + current_dist_amount %}
                            
                            {# Only display items that were paid or have remaining balance #}
                            {% if max_allowed > 0 or current_dist_amount > 0 %}
                            <tr>
                                <td>{{ inv_item.description | truncate(70) }}</td>
                                <td class="text-end number-cell text-primary fw-bold">{{ "{:,.2f}".format(max_allowed) }}</td>
                                <td>
                                    <input type="number" 
                                           class="form-control form-control-sm payment-dist-input"
                                           name="dist_item_{{ inv_item.id }}" 
                                           step="0.01" 
                                           min="0"
                                           max="{{ '%.2f'|format(max_allowed) }}" {# Pass the float value formatted to 2 decimals #}
                                           value="{{ '%.2f'|format(current_dist_amount) if current_dist_amount > 0 else '' }}"
                                           placeholder="0.00">
                                </td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="mt-4 d-flex justify-content-between">
                 <div>
                    <strong class="text-muted">إجمالي الدفعة الكلي: </strong>
                    <span id="totalPaymentAmount" class="fw-bold text-success fs-5 number-cell">0.00</span> <span class="text-muted">ر.س</span>
                </div>
                <div>
                    <button type="submit" id="submitPaymentBtn" class="btn btn-primary" disabled>
                        <i class="fas fa-save me-1"></i> حفظ التعديلات
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const paymentForm = document.getElementById('paymentForm');
    if (paymentForm) {
        const distInputs = paymentForm.querySelectorAll('.payment-dist-input');
        const totalAmountDisplay = paymentForm.querySelector('#totalPaymentAmount');
        const submitBtn = paymentForm.querySelector('#submitPaymentBtn');

        function updateTotal() {
            let total = 0;
            distInputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                total += value;
            });
            
            // تحديث العرض باستخدام التنسيق المناسب
            totalAmountDisplay.textContent = total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            // تمكين/تعطيل زر الإرسال بناءً على الإجمالي (أكبر من صفر)
            // نستخدم قيمة المبلغ الأصلي للدفع كمرجع إذا لم يتم إدخال شيء
            const hasPositiveTotal = total > 0;
            submitBtn.disabled = !hasPositiveTotal;
        }

        distInputs.forEach(input => {
            input.addEventListener('input', () => {
                const value = parseFloat(input.value) || 0;
                const max = parseFloat(input.max);
                
                // منع تجاوز الحد الأقصى ديناميكيًا
                if (value > max) {
                    input.value = max.toFixed(2);
                }
                
                if (value < 0) {
                    input.value = 0;
                }
                
                updateTotal();
            });
        });
        
        // Initial calculation on page load
        updateTotal();
    }
});
</script>
{% endblock %}